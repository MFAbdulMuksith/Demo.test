Below are the `README.md` files for each service in your setup, along with configuration details for beginners. These READMEs provide an overview of each service, its purpose, and basic setup instructions.

---

## **README.md for Prometheus**

### **Overview**
Prometheus is an open-source monitoring and alerting toolkit designed for reliability and scalability. It collects metrics from configured targets at given intervals, evaluates rule expressions, and triggers alerts if certain conditions are met.

### **Configuration**
1. **Configuration File**: The main configuration file is located at `/opt/container/prometheus/prometheus.yml`. This file defines scrape targets, alerting rules, and other settings.
2. **Alert Rules**: Alert rules are defined in `/opt/container/prometheus/alert.rules.yml`.
3. **Data Storage**: Metrics data is stored in `/opt/container/prometheus/data`.

### **Usage**
- Access the Prometheus web UI at `http://localhost:9090`.
- Reload the configuration without restarting the service:
  ```bash
  curl -X POST http://localhost:9090/-/reload
  ```

### **Docker Compose Configuration**
```yaml
prometheus:
  image: prom/prometheus:v2.40.2
  ports:
    - 9090:9090
  volumes:
    - /opt/container/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    - /opt/container/prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml
    - /opt/container/prometheus/data:/prometheus
  command:
    - "--config.file=/etc/prometheus/prometheus.yml"
    - "--storage.tsdb.path=/prometheus"
    - "--storage.tsdb.retention.time=90d"
    - "--web.enable-lifecycle"
```

---

## **README.md for Alertmanager**

### **Overview**
Alertmanager handles alerts sent by Prometheus. It deduplicates, groups, and routes alerts to the correct receiver (e.g., email, Slack).

### **Configuration**
1. **Configuration File**: The main configuration file is located at `/opt/container/alertmanager/alertmanager.yml`. This file defines alert routing and notification settings.

### **Usage**
- Access the Alertmanager web UI at `http://localhost:9093`.

### **Docker Compose Configuration**
```yaml
alert:
  image: prom/alertmanager:v0.24.0
  ports:
    - 9093:9093
  volumes:
    - /opt/container/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  command:
    - "--config.file=/etc/alertmanager/alertmanager.yml"
```

---

## **README.md for Grafana**

### **Overview**
Grafana is an open-source platform for monitoring and observability. It allows you to visualize metrics from Prometheus and other data sources.

### **Configuration**
1. **Data Storage**: Grafana data is stored in `/opt/container/grafana/data`.
2. **Traefik Integration**: Grafana is exposed via Traefik with TLS enabled.

### **Usage**
- Access the Grafana web UI at `https://monitor.ascension-holding.com`.

### **Docker Compose Configuration**
```yaml
grafana:
  image: grafana/grafana:9.2.5
  ports:
    - 3000:3000
  volumes:
    - /opt/container/grafana/data:/var/lib/grafana
  labels:
    - traefik.enable=true
    - traefik.http.routers.grafana.rule=Host(`monitor.ascension-holding.com`)
    - traefik.http.routers.grafana.entrypoints=websecure
    - traefik.http.routers.grafana.tls=true
    - traefik.http.routers.grafana.tls.certresolver=myresolver
```

---

## **README.md for cAdvisor**

### **Overview**
cAdvisor (Container Advisor) provides container users with an understanding of resource usage and performance characteristics of their running containers.

### **Usage**
- Access the cAdvisor web UI at `http://localhost:8080`.

### **Docker Compose Configuration**
```yaml
cadvisor:
  image: gcr.io/cadvisor/cadvisor:v0.46.0
  ports:
    - 8080:8080
  volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:rw
    - /sys:/sys:ro
    - /var/lib/docker/:/var/lib/docker:ro
```

---

## **README.md for Blackbox Exporter**

### **Overview**
Blackbox Exporter allows blackbox probing of endpoints over HTTP, HTTPS, DNS, TCP, and ICMP.

### **Configuration**
1. **Configuration File**: The main configuration file is located at `/opt/container/blackbox/config.yml`.

### **Usage**
- Access the Blackbox Exporter metrics at `http://localhost:9115/metrics`.

### **Docker Compose Configuration**
```yaml
blackbox-exporter:
  image: prom/blackbox-exporter:v0.22.0
  ports:
    - 9115:9115
  volumes:
    - /opt/container/blackbox/config.yml:/etc/blackbox_exporter/config.yml
  command:
    - "--config.file=/etc/blackbox_exporter/config.yml"
```

---

## **README.md for Traefik**

### **Overview**
Traefik is a modern reverse proxy and load balancer that integrates with Docker. It automatically routes traffic to services based on labels.

### **Configuration**
1. **Dashboard**: Access the Traefik dashboard at `http://localhost:8050`.
2. **TLS Certificates**: Certificates are managed using Let's Encrypt and stored in `acme.json`.

### **Docker Compose Configuration**
```yaml
traefik:
  image: traefik:v2.9
  ports:
    - 80:80
    - 443:443
    - 8050:8080
  command:
    - "--log.level=ERROR"
    - "--api.insecure=true"
    - "--api.dashboard=true"
    - "--providers.docker=true"
    - "--providers.docker.exposedbydefault=false"
    - "--providers.docker.network=monitor"
    - "--entrypoints.web.address=:80"
    - "--entrypoints.websecure.address=:443"
    - "--certificatesresolvers.myresolver.acme.email=devops@ascension-holding.com"
    - "--certificatesresolvers.myresolver.acme.storage=acme.json"
    - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
```

---

## **README.md for Loki**

### **Overview**
Loki is a horizontally scalable, highly available, multi-tenant log aggregation system inspired by Prometheus.

### **Configuration**
1. **Configuration File**: The main configuration file is located at `/opt/container/loki/loki-config.yaml`.
2. **Data Storage**: Logs are stored in `/opt/prometheus/loki-data`.

### **Usage**
- Access the Loki API at `http://localhost:3100`.

### **Docker Compose Configuration**
```yaml
loki:
  image: grafana/loki:3.2.1
  ports:
    - "3100:3100"
  volumes:
    - /opt/container/loki/loki-config.yaml:/etc/loki/loki-config.yaml
    - /opt/prometheus/loki-data:/data/loki
  command:
    - "--config.file=/etc/loki/loki-config.yaml"
```

---

## **General Notes**
1. **Networks**: All services are connected to the `monitor` network.
2. **Environment Variables**: The `.env` file contains environment-specific configurations.
3. **Scripts**:
   - `docker_compose.sh`: Script to manage Docker Compose.
   - `set-local.sh`: Script for local environment setup.

For further details, refer to the official documentation of each service.


---
# ===
---

Below is a detailed guide on how to configure the configuration files for each service in your setup. This documentation can be added to the `README.md` file for each service to help beginners understand and set up the services.

---

## **Configuration Files for Each Service**

### **1. Prometheus**
#### **Configuration File: `prometheus.yml`**
Location: `/opt/container/prometheus/prometheus.yml`

```yaml
global:
  scrape_interval: 15s # How often to scrape targets
  evaluation_interval: 15s # How often to evaluate rules

scrape_configs:
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"] # Scrape Prometheus itself

  - job_name: "cadvisor"
    static_configs:
      - targets: ["cadvisor:8080"] # Scrape cAdvisor metrics

  - job_name: "blackbox"
    metrics_path: /probe
    params:
      module: [http_2xx] # Probe HTTP endpoints
    static_configs:
      - targets:
          - http://example.com # Example target
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox_exporter:9115 # Blackbox Exporter address

rule_files:
  - "/etc/prometheus/alert.rules.yml" # Path to alert rules file
```

#### **Alert Rules File: `alert.rules.yml`**
Location: `/opt/container/prometheus/alert.rules.yml`

```yaml
groups:
  - name: example
    rules:
      - alert: HighRequestLatency
        expr: job:request_latency_seconds:mean5m{job="myjob"} > 0.5
        for: 10m
        labels:
          severity: page
        annotations:
          summary: "High request latency"
          description: "Request latency is above 0.5 seconds for the past 10 minutes."
```

---

### **2. Alertmanager**
#### **Configuration File: `alertmanager.yml`**
Location: `/opt/container/alertmanager/alertmanager.yml`

```yaml
global:
  resolve_timeout: 5m

route:
  receiver: "email-notifications"
  group_by: [alertname, job]
  routes:
    - match:
        severity: "critical"
      receiver: "email-notifications"

receivers:
  - name: "email-notifications"
    email_configs:
      - to: "devops@ascension-holding.com"
        from: "alertmanager@ascension-holding.com"
        smarthost: "smtp.example.com:587"
        auth_username: "user@example.com"
        auth_password: "password"
        require_tls: true

inhibit_rules:
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["alertname", "job"]
```

---

### **3. Grafana**
#### **Data Source Configuration**
1. Log in to Grafana at `http://localhost:3000`.
2. Add Prometheus as a data source:
   - Go to **Configuration > Data Sources > Add data source**.
   - Select **Prometheus**.
   - Set the URL to `http://prometheus:9090`.
   - Save and test the connection.

#### **Dashboards**
- Import pre-built dashboards from the [Grafana Dashboard Library](https://grafana.com/grafana/dashboards/).
- Example: Use the [Node Exporter Full](https://grafana.com/grafana/dashboards/1860) dashboard for system metrics.

---

### **4. cAdvisor**
cAdvisor does not require a configuration file. It automatically collects metrics from running containers.

---

### **5. Blackbox Exporter**
#### **Configuration File: `config.yml`**
Location: `/opt/container/blackbox/config.yml`

```yaml
modules:
  http_2xx:
    prober: http
    http:
      preferred_ip_protocol: "ip4"
      valid_status_codes: [200]
      no_follow_redirects: false
  tcp_connect:
    prober: tcp
  icmp:
    prober: icmp
```

---

### **6. Traefik**
#### **Configuration File: `traefik.yml`**
Traefik is configured via Docker labels in the `docker-compose.yml` file. No additional configuration file is required.

---

### **7. Loki**
#### **Configuration File: `loki-config.yaml`**
Location: `/opt/container/loki/loki-config.yaml`

```yaml
auth_enabled: false

server:
  http_listen_port: 3100

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s
  chunk_idle_period: 1h
  max_chunk_age: 1h

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb:
    directory: /data/loki/index
  filesystem:
    directory: /data/loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: false
  retention_period: 0s
```

---

## **README.md Template for Each Service**

Below is a template for the `README.md` file for each service. Customize it as needed.

```markdown
# [Service Name]

## **Overview**
[Brief description of the service and its purpose.]

## **Configuration**
1. **Configuration File**: [Path to the configuration file.]
2. **Key Settings**:
   - [Setting 1]: [Description]
   - [Setting 2]: [Description]
3. **Data Storage**: [Path to data storage, if applicable.]

## **Usage**
- Access the service at [URL or port].
- Example commands or API calls.

## **Docker Compose Configuration**
```yaml
[Copy the relevant Docker Compose configuration here.]
```

## **Troubleshooting**
- Common issues and solutions.
- Logs location: [Path to logs.]

## **References**
- [Official Documentation](https://example.com)
- [Useful Tutorials or Guides](https://example.com)
```

---

## **Example: Prometheus README.md**

```markdown
# Prometheus

## **Overview**
Prometheus is an open-source monitoring and alerting toolkit designed for reliability and scalability.

## **Configuration**
1. **Configuration File**: `/opt/container/prometheus/prometheus.yml`
2. **Key Settings**:
   - `scrape_interval`: How often to scrape targets.
   - `evaluation_interval`: How often to evaluate rules.
3. **Data Storage**: `/opt/container/prometheus/data`

## **Usage**
- Access the Prometheus web UI at `http://localhost:9090`.
- Reload the configuration without restarting:
  ```bash
  curl -X POST http://localhost:9090/-/reload
  ```

## **Docker Compose Configuration**
```yaml
prometheus:
  image: prom/prometheus:v2.40.2
  ports:
    - 9090:9090
  volumes:
    - /opt/container/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    - /opt/container/prometheus/alert.rules.yml:/etc/prometheus/alert.rules.yml
    - /opt/container/prometheus/data:/prometheus
  command:
    - "--config.file=/etc/prometheus/prometheus.yml"
    - "--storage.tsdb.path=/prometheus"
    - "--storage.tsdb.retention.time=90d"
    - "--web.enable-lifecycle"
```

## **Troubleshooting**
- Check logs: `docker logs prometheus`
- Ensure the configuration file is valid.

## **References**
- [Official Documentation](https://prometheus.io/docs/)
- [Prometheus Alerting Guide](https://prometheus.io/docs/alerting/latest/overview/)
```

---

Repeat this structure for each service, customizing the details as needed. This will provide a comprehensive guide for beginners to configure and use each service.

Continuing from where we left off, here are the `README.md` files for the remaining services, following the same structure and providing detailed configuration instructions.

---

## **README.md for Alertmanager**

```markdown
# Alertmanager

## **Overview**
Alertmanager handles alerts sent by Prometheus. It deduplicates, groups, and routes alerts to the correct receiver (e.g., email, Slack).

## **Configuration**
1. **Configuration File**: `/opt/container/alertmanager/alertmanager.yml`
2. **Key Settings**:
   - `route`: Defines how alerts are routed to receivers.
   - `receivers`: Configures notification channels (e.g., email, Slack).
   - `inhibit_rules`: Suppresses notifications for lower-priority alerts when a higher-priority alert is firing.

## **Usage**
- Access the Alertmanager web UI at `http://localhost:9093`.
- Test alert routing by sending a test alert:
  ```bash
  curl -H "Content-Type: application/json" -d '[{"labels":{"alertname":"TestAlert"}}]' http://localhost:9093/api/v1/alerts
  ```

## **Docker Compose Configuration**
```yaml
alert:
  image: prom/alertmanager:v0.24.0
  ports:
    - 9093:9093
  volumes:
    - /opt/container/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml
  command:
    - "--config.file=/etc/alertmanager/alertmanager.yml"
```

## **Troubleshooting**
- Check logs: `docker logs alertmanager`
- Validate the configuration file using the `amtool`:
  ```bash
  amtool check-config /opt/container/alertmanager/alertmanager.yml
  ```

## **References**
- [Official Documentation](https://prometheus.io/docs/alerting/latest/alertmanager/)
- [Alertmanager Configuration Guide](https://prometheus.io/docs/alerting/latest/configuration/)
```

---

## **README.md for Grafana**

```markdown
# Grafana

## **Overview**
Grafana is an open-source platform for monitoring and observability. It allows you to visualize metrics from Prometheus and other data sources.

## **Configuration**
1. **Data Storage**: Grafana data is stored in `/opt/container/grafana/data`.
2. **Data Sources**:
   - Add Prometheus as a data source in the Grafana UI:
     - URL: `http://prometheus:9090`
   - Add Loki as a data source for logs:
     - URL: `http://loki:3100`
3. **Dashboards**:
   - Import pre-built dashboards from the [Grafana Dashboard Library](https://grafana.com/grafana/dashboards/).

## **Usage**
- Access the Grafana web UI at `https://monitor.ascension-holding.com`.
- Default credentials: `admin/admin` (change after first login).

## **Docker Compose Configuration**
```yaml
grafana:
  image: grafana/grafana:9.2.5
  ports:
    - 3000:3000
  volumes:
    - /opt/container/grafana/data:/var/lib/grafana
  labels:
    - traefik.enable=true
    - traefik.http.routers.grafana.rule=Host(`monitor.ascension-holding.com`)
    - traefik.http.routers.grafana.entrypoints=websecure
    - traefik.http.routers.grafana.tls=true
    - traefik.http.routers.grafana.tls.certresolver=myresolver
```

## **Troubleshooting**
- Check logs: `docker logs grafana`
- Ensure the data source URLs are correct.

## **References**
- [Official Documentation](https://grafana.com/docs/)
- [Grafana Dashboard Library](https://grafana.com/grafana/dashboards/)
```

---

## **README.md for cAdvisor**

```markdown
# cAdvisor

## **Overview**
cAdvisor (Container Advisor) provides container users with an understanding of resource usage and performance characteristics of their running containers.

## **Configuration**
cAdvisor does not require a configuration file. It automatically collects metrics from running containers.

## **Usage**
- Access the cAdvisor web UI at `http://localhost:8080`.
- Metrics are available at `http://localhost:8080/metrics`.

## **Docker Compose Configuration**
```yaml
cadvisor:
  image: gcr.io/cadvisor/cadvisor:v0.46.0
  ports:
    - 8080:8080
  volumes:
    - /:/rootfs:ro
    - /var/run:/var/run:rw
    - /sys:/sys:ro
    - /var/lib/docker/:/var/lib/docker:ro
```

## **Troubleshooting**
- Check logs: `docker logs cadvisor`
- Ensure Docker is running and accessible.

## **References**
- [Official GitHub Repository](https://github.com/google/cadvisor)
```

---

## **README.md for Blackbox Exporter**

```markdown
# Blackbox Exporter

## **Overview**
Blackbox Exporter allows blackbox probing of endpoints over HTTP, HTTPS, DNS, TCP, and ICMP.

## **Configuration**
1. **Configuration File**: `/opt/container/blackbox/config.yml`
2. **Modules**:
   - `http_2xx`: Probes HTTP endpoints for a 200 status code.
   - `tcp_connect`: Probes TCP connections.
   - `icmp`: Probes ICMP (ping) requests.

## **Usage**
- Access the Blackbox Exporter metrics at `http://localhost:9115/metrics`.
- Example probe: `http://blackbox_exporter:9115/probe?target=http://example.com&module=http_2xx`.

## **Docker Compose Configuration**
```yaml
blackbox-exporter:
  image: prom/blackbox-exporter:v0.22.0
  ports:
    - 9115:9115
  volumes:
    - /opt/container/blackbox/config.yml:/etc/blackbox_exporter/config.yml
  command:
    - "--config.file=/etc/blackbox_exporter/config.yml"
```

## **Troubleshooting**
- Check logs: `docker logs blackbox_exporter`
- Validate the configuration file using the `blackbox_exporter` binary:
  ```bash
  blackbox_exporter --config.check --config.file=/opt/container/blackbox/config.yml
  ```

## **References**
- [Official Documentation](https://github.com/prometheus/blackbox_exporter)
```

---

## **README.md for Traefik**

```markdown
# Traefik

## **Overview**
Traefik is a modern reverse proxy and load balancer that integrates with Docker. It automatically routes traffic to services based on labels.

## **Configuration**
1. **Dashboard**: Access the Traefik dashboard at `http://localhost:8050`.
2. **TLS Certificates**: Certificates are managed using Let's Encrypt and stored in `acme.json`.

## **Usage**
- Access the Traefik dashboard at `http://localhost:8050`.
- Expose services by adding Traefik labels to the `docker-compose.yml` file.

## **Docker Compose Configuration**
```yaml
traefik:
  image: traefik:v2.9
  ports:
    - 80:80
    - 443:443
    - 8050:8080
  command:
    - "--log.level=ERROR"
    - "--api.insecure=true"
    - "--api.dashboard=true"
    - "--providers.docker=true"
    - "--providers.docker.exposedbydefault=false"
    - "--providers.docker.network=monitor"
    - "--entrypoints.web.address=:80"
    - "--entrypoints.websecure.address=:443"
    - "--certificatesresolvers.myresolver.acme.email=devops@ascension-holding.com"
    - "--certificatesresolvers.myresolver.acme.storage=acme.json"
    - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web"
  volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
```

## **Troubleshooting**
- Check logs: `docker logs traefik`
- Ensure the `acme.json` file has the correct permissions:
  ```bash
  chmod 600 acme.json
  ```

## **References**
- [Official Documentation](https://doc.traefik.io/traefik/)
```

---

## **README.md for Loki**

```markdown
# Loki

## **Overview**
Loki is a horizontally scalable, highly available, multi-tenant log aggregation system inspired by Prometheus.

## **Configuration**
1. **Configuration File**: `/opt/container/loki/loki-config.yaml`
2. **Data Storage**: Logs are stored in `/opt/prometheus/loki-data`.

## **Usage**
- Access the Loki API at `http://localhost:3100`.
- Query logs using LogQL in Grafana.

## **Docker Compose Configuration**
```yaml
loki:
  image: grafana/loki:3.2.1
  ports:
    - "3100:3100"
  volumes:
    - /opt/container/loki/loki-config.yaml:/etc/loki/loki-config.yaml
    - /opt/prometheus/loki-data:/data/loki
  command:
    - "--config.file=/etc/loki/loki-config.yaml"
```

## **Troubleshooting**
- Check logs: `docker logs loki`
- Validate the configuration file using the `loki` binary:
  ```bash
  loki --config.file=/opt/container/loki/loki-config.yaml --config.expand-env=true --log.level=debug
  ```

## **References**
- [Official Documentation](https://grafana.com/docs/loki/latest/)
- [LogQL Guide](https://grafana.com/docs/loki/latest/logql/)
```

---

## **General Notes for All Services**
- **Networks**: All services are connected to the `monitor` network.
- **Environment Variables**: The `.env` file contains environment-specific configurations.
- **Scripts**:
  - `docker_compose.sh`: Script to manage Docker Compose.
  - `set-local.sh`: Script for local environment setup.

---

This documentation provides a comprehensive guide for beginners to configure and use each service. You can add these `README.md` files to the respective service directories for easy reference.

---

The `set-local.sh` script you provided is well-structured and covers most of the necessary steps to set up the monitoring stack using Docker Compose. However, there are a few areas where improvements or corrections can be made to ensure it works seamlessly with your `docker-compose.yml` file and the overall setup. Below is a detailed review and suggestions for improvement:

---

### **Review and Suggestions**

#### **1. Directory Creation**
- The script creates directories for each service (`prometheus`, `alertmanager`, `grafana`, `blackbox`, `loki`, and `traefik`). This is correct and aligns with the volume mounts in your `docker-compose.yml`.
- **Suggestion**: Ensure the `mkdir -p` command is used for all directories to avoid errors if they already exist.

#### **2. File Copying**
- The `copy_if_not_exists` function is a good approach to avoid overwriting existing configuration files.
- **Suggestion**: Add a check to ensure the source files exist before attempting to copy them. For example:
  ```bash
  if [[ ! -f "$src" ]]; then
      echo "Error: Source file $src not found. Skipping."
      return
  fi
  ```

#### **3. Permissions**
- The script sets permissions for configuration files and data directories. This is important for security and proper functioning of the services.
- **Suggestion**: Double-check the ownership and permissions for each service:
  - Prometheus: The `prometheus` user typically has UID `65534`. Ensure the `prometheus/data` directory is owned by this user.
  - Grafana: The `grafana` user typically has UID `472`. Ensure the `grafana/data` directory is owned by this user.
  - Loki: The `loki` user typically has UID `10001`. Ensure the `loki` directory is owned by this user.
  - Traefik: The `acme.json` file should have `600` permissions to protect sensitive certificate data.

#### **4. Docker Network**
- The script checks if the `monitor` network exists and creates it if it doesn't. This is correct and aligns with the `docker-compose.yml` file.
- **Suggestion**: Add a check to ensure the network is created successfully:
  ```bash
  if ! docker network create monitor; then
      echo "Error: Failed to create 'monitor' Docker network."
      exit 1
  fi
  ```

#### **5. Docker Compose Check**
- The script checks if `docker-compose` is installed. This is good practice.
- **Suggestion**: If `docker-compose` is not installed, provide instructions for installation or suggest using `docker compose` (the newer syntax).

#### **6. Starting Services**
- The script uses `docker-compose up -d` to start the services in detached mode. This is correct.
- **Suggestion**: Add a check to ensure the services started successfully:
  ```bash
  if ! docker-compose up -d; then
      echo "Error: Failed to start Docker services."
      exit 1
  fi
  ```

#### **7. Final Output**
- The script provides a final status message with URLs to access the services. This is helpful for users.
- **Suggestion**: Replace `<SERVER_IP>` with the actual server IP or hostname. You can use `hostname -I` or `curl ifconfig.me` to fetch the IP dynamically.

---

### **Updated Script**
Here’s the updated script with the above suggestions applied:

```bash
#!/bin/bash

# Ensure script is run as root
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root or with sudo."
   exit 1
fi

# Define base directory for configurations and data
BASE_DIR="/opt/container"
PROMETHEUS_DIR="$BASE_DIR/prometheus"
ALERTMANAGER_DIR="$BASE_DIR/alertmanager"
GRAFANA_DIR="$BASE_DIR/grafana"
BLACKBOX_DIR="$BASE_DIR/blackbox"
LOKI_DIR="$BASE_DIR/loki"
TRAEFIK_DIR="$BASE_DIR/traefik"

# Create necessary directories
echo "Creating required directories..."
mkdir -p $PROMETHEUS_DIR/data
mkdir -p $ALERTMANAGER_DIR
mkdir -p $GRAFANA_DIR/data
mkdir -p $BLACKBOX_DIR
mkdir -p $LOKI_DIR
mkdir -p $TRAEFIK_DIR

# Set proper permissions for base directory
chmod -R 755 $BASE_DIR

# Function to copy files if they do not exist
copy_if_not_exists() {
    local src=$1
    local dest=$2
    if [[ ! -f "$src" ]]; then
        echo "Warning: Source file $src not found. Skipping."
        return
    fi
    if [[ ! -f "$dest" ]]; then
        echo "Copying $src to $dest"
        cp "$src" "$dest"
    else
        echo "Skipping $dest (already exists)."
    fi
}

# Copy configuration files only if they don't already exist
echo "Copying configuration files (if not already present)..."

copy_if_not_exists ./prometheus/prometheus.yml $PROMETHEUS_DIR/prometheus.yml
copy_if_not_exists ./prometheus/alert.rules.yml $PROMETHEUS_DIR/alert.rules.yml
copy_if_not_exists ./alertmanager/alertmanager.yml $ALERTMANAGER_DIR/alertmanager.yml
copy_if_not_exists ./blackbox-exporter/config.yml $BLACKBOX_DIR/config.yml
copy_if_not_exists ./loki/loki-config.yaml $LOKI_DIR/loki-config.yaml

# Set permissions function
set_permissions() {
    local file=$1
    local owner=$2
    local mode=$3
    if [[ -f "$file" ]]; then
        echo "Setting permissions for $file"
        chown "$owner" "$file"
        chmod "$mode" "$file"
    fi
}

# Apply permissions to configuration files
set_permissions $PROMETHEUS_DIR/prometheus.yml root:root 644
set_permissions $PROMETHEUS_DIR/alert.rules.yml root:root 644
set_permissions $ALERTMANAGER_DIR/alertmanager.yml root:root 644
set_permissions $BLACKBOX_DIR/config.yml root:root 644
set_permissions $LOKI_DIR/loki-config.yaml root:root 644

# Set ownership and permissions for data directories
echo "Setting data directory permissions..."
chown -R 65534:65534 $PROMETHEUS_DIR/data
chmod -R 755 $PROMETHEUS_DIR/data

chown -R 472:472 $GRAFANA_DIR/data
chmod -R 755 $GRAFANA_DIR/data

chown -R 10001:10001 $LOKI_DIR
chmod -R 755 $LOKI_DIR

# Set special permissions for Traefik acme.json file
echo "Ensuring Traefik acme.json permissions..."
touch $TRAEFIK_DIR/acme.json
chmod 600 $TRAEFIK_DIR/acme.json

# Ensure Docker network exists before running services
if ! docker network inspect monitor >/dev/null 2>&1; then
    echo "Creating 'monitor' Docker network..."
    if ! docker network create monitor; then
        echo "Error: Failed to create 'monitor' Docker network."
        exit 1
    fi
fi

# Ensure Docker Compose is installed
if ! command -v docker-compose &>/dev/null; then
    echo "Error: docker-compose is not installed. Install it and try again."
    exit 1
fi

# Start the monitoring stack
echo "Starting Docker services..."
if ! docker-compose up -d; then
    echo "Error: Failed to start Docker services."
    exit 1
fi

# Fetch server IP
SERVER_IP=$(hostname -I | awk '{print $1}')
if [[ -z "$SERVER_IP" ]]; then
    SERVER_IP="<SERVER_IP>"
fi

# Final status
echo "✅ Monitoring Environment setup completed!"
echo "🌍 Test access to services:"
echo "📌 Prometheus: http://$SERVER_IP:9090"
echo "📌 Grafana: http://$SERVER_IP:3000"
echo "📌 Alertmanager: http://$SERVER_IP:9093"
echo "📌 Traefik Dashboard: http://$SERVER_IP:8050"
```

---

### **Key Improvements**
1. **Error Handling**: Added checks for critical operations (e.g., network creation, Docker Compose startup).
2. **Dynamic IP**: Fetches the server IP dynamically for the final output.
3. **File Existence Check**: Ensures source files exist before attempting to copy them.
4. **Permissions**: Ensures correct ownership and permissions for all directories and files.

This script should now work seamlessly with your `docker-compose.yml` file and provide a robust setup for your monitoring stack.

---

The `docker_compose.sh` script you provided is mostly correct and well-structured for installing Docker and Docker Compose on Ubuntu servers. However, there are a few improvements and corrections that can be made to ensure compatibility with the latest versions and best practices. Below is a detailed review and an updated version of the script.

---

### **Review and Suggestions**

#### **1. Docker Installation**
- The script uses the official Docker installation script (`https://get.docker.com`), which is a good practice.
- **Suggestion**: Add a check to ensure `curl` is installed before attempting to download the script:
  ```bash
  if ! command -v curl &>/dev/null; then
      echo "curl is not installed. Installing curl..."
      sudo apt-get update && sudo apt-get install -y curl
  fi
  ```

#### **2. Docker Compose Installation**
- The script installs Docker Compose by downloading the binary from GitHub. This is correct for the latest versions of Docker Compose (v2.x).
- **Suggestion**: Use the `docker compose` plugin (included with Docker Desktop and Docker Engine v20.10+) instead of the standalone `docker-compose` binary. This is the recommended approach for newer Docker installations.

#### **3. User Group Changes**
- The script adds the current user to the `docker` group, which is necessary to run Docker commands without `sudo`.
- **Suggestion**: Inform the user to log out and back in (or reboot) for the group changes to take effect. This is already included in your script.

#### **4. Error Handling**
- The script uses `set -e` to exit immediately if a command fails. This is good practice.
- **Suggestion**: Add more specific error handling for critical steps (e.g., Docker installation, Docker Compose download).

#### **5. Docker Compose Version**
- The script hardcodes the Docker Compose version (`v2.23.3`). This is fine, but you might want to fetch the latest version dynamically or allow the user to specify a version.

#### **6. Systemd Services**
- The script enables `docker.service` and `containerd.service` to start on boot. This is correct.

---

### **Updated Script**
Here’s the updated script with the above improvements applied:

```bash
#!/bin/bash

# Exit immediately if a command exits with a non-zero status
set -e

echo "Starting Docker and Docker Compose installation..."

# Ensure curl is installed
if ! command -v curl &>/dev/null; then
    echo "curl is not installed. Installing curl..."
    sudo apt-get update && sudo apt-get install -y curl
fi

# Install Docker
echo "Downloading Docker installation script..."
curl -fsSL https://get.docker.com -o install-docker.sh

echo "Making the script executable..."
sudo chmod +x install-docker.sh

echo "Running Docker installation script..."
sudo sh install-docker.sh

echo "Verifying Docker installation..."
docker --version

echo "Checking Docker service status..."
if sudo systemctl is-active --quiet docker; then
    echo "Docker is running."
else
    echo "Docker is NOT running. Starting Docker..."
    sudo systemctl start docker
fi

echo "Running a test Docker container..."
sudo docker run hello-world

echo "Adding current user ($USER) to the Docker group..."
sudo usermod -aG docker $USER

echo "Restarting Docker to apply group changes..."
sudo systemctl restart docker

echo "IMPORTANT: You must log out and back in (or reboot) for the group changes to take effect."
echo "Once logged back in, run: docker run hello-world"

# Install Docker Compose (as a Docker plugin)
DOCKER_COMPOSE_VERSION="v2.23.3"
DOCKER_COMPOSE_URL="https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)"

echo "Downloading Docker Compose (Version: ${DOCKER_COMPOSE_VERSION})..."
sudo curl -L "$DOCKER_COMPOSE_URL" -o /usr/local/bin/docker-compose

echo "Making Docker Compose executable..."
sudo chmod +x /usr/local/bin/docker-compose

echo "Creating a symbolic link for 'docker-compose' to 'docker compose'..."
sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose

echo "Verifying Docker Compose installation..."
docker-compose --version

# Enable Docker and containerd services
echo "Enabling Docker and containerd services to start on boot..."
sudo systemctl enable docker.service
sudo systemctl enable containerd.service

echo "Docker and Docker Compose installation completed successfully!"
```

---

### **Key Improvements**
1. **Dynamic Docker Compose Version**: You can modify the script to fetch the latest version dynamically:
   ```bash
   DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
   ```
2. **Docker Compose as a Plugin**: The script now creates a symbolic link for `docker-compose` to ensure compatibility with both `docker-compose` and `docker compose` commands.
3. **Error Handling**: Added checks for `curl` installation and improved error handling for critical steps.
4. **User Feedback**: Improved user feedback with clear messages and instructions.

---

### **Usage**
1. Save the script as `docker_compose.sh`.
2. Make it executable:
   ```bash
   chmod +x docker_compose.sh
   ```
3. Run the script:
   ```bash
   sudo ./docker_compose.sh
   ```

This updated script should work seamlessly for installing Docker and Docker Compose on Ubuntu servers, ensuring compatibility with the latest versions and best practices.

---
# ===
---

Your configuration for Promtail and Docker Compose looks mostly correct, but there are a few things to double-check and clarify:

---

### **1. Promtail Configuration (`promtail-config.yaml`)**
- **`clients.url`**: Ensure that the Loki server at `http://10.0.3.110:3100` is reachable from the Promtail instance. If Loki is running in a different network or requires authentication, you may need to adjust this configuration.
- **`targets`**: The `targets` field is typically used for service discovery, but in your case, it seems redundant since you're explicitly defining the log paths in `__path__`. You can remove the `targets` section unless you have a specific use case for it.
- **`__path__`**: Ensure that the path `/var/log/*.log` exists and contains the logs you want to collect. If you want to collect all logs in `/var/log/`, you can use `/var/log/**/*.log` instead.

Here’s a slightly cleaned-up version of your `promtail-config.yaml`:

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

clients:
  - url: http://10.0.3.110:3100/loki/api/v1/push  # Replace with the central Loki server's IP

positions:
  filename: /tmp/positions.yaml

scrape_configs:
  - job_name: system
    static_configs:
      - labels:
          job: server_logs
          server: Gopromate-Production-02  # Replace with the server's name
          environment: Production
          __path__: /var/log/*.log     # Logs to be collected (you can change this path as needed)
```

---

### **2. Docker Compose Configuration (`docker-compose.yml`)**
- **Volumes**:
  - The volume mapping for `/var/log:/var/log` is correct and ensures Promtail can access the host's logs.
  - The `positions.yaml` file is correctly mapped to `/tmp/positions.yaml` in the container, which matches the `positions.filename` in your Promtail config.
  - The `/tmp:/tmp` mapping is optional unless you have other reasons to share the `/tmp` directory between the host and container.
- **Command**: The `command` is correctly pointing to the config file.

Here’s your `docker-compose.yml` with minor clarifications:

```yaml
version: '3'
services:
  promtail:
    image: grafana/promtail:latest
    container_name: promtail
    volumes:
      - /opt/promtail/promtail-config.yaml:/etc/promtail/config.yaml
      - /var/log:/var/log
      - /opt/promtail/positions.yaml:/tmp/positions.yaml
      - /tmp:/tmp
    command: -config.file=/etc/promtail/config.yaml
    restart: always
```

---

### **3. Additional Notes**
- **Permissions**: Ensure the Promtail container has the necessary permissions to read the logs in `/var/log/`. If the logs are restricted, you may need to adjust file permissions or run the container with elevated privileges (e.g., `user: root` in the Docker Compose file).
- **Loki Server**: Double-check that the Loki server at `http://10.0.3.110:3100` is running and accessible from the Promtail instance.
- **Log Rotation**: If your logs are rotated (e.g., using `logrotate`), ensure Promtail can handle rotated logs. By default, Promtail should handle this, but you may need to adjust configurations if you encounter issues.

---

### **4. Testing**
After starting the Docker container, you can check the logs of the Promtail container to ensure it’s running correctly:

```bash
docker logs -f promtail
```

Look for any errors or warnings in the logs. If everything is working, you should see logs being shipped to Loki.

---

### **Final Thoughts**
Your configuration is mostly correct and should work as expected. Just ensure the Loki server is reachable and that Promtail has the necessary permissions to read the logs. If you encounter any issues, the Promtail logs will be the best place to start debugging.

---

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

clients:
  - url: http://10.0.3.110:3100/loki/api/v1/push  # Replace with the central Loki server's IP

positions:
  filename: /tmp/positions.yaml

scrape_configs:
  - job_name: system
    static_configs:
      - labels:
          job: server_logs
          server: Achieve-Cargo-Prod-1-V2  # Replace with the server's name
          environment: Production
          __path__: /var/log/*.log     # Logs to be collected (you can change this path as needed)
```

---

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

clients:
  - url: http://10.0.3.110:3100/loki/api/v1/push  # Replace with the central Loki server's IP

positions:
  filename: /tmp/positions.yaml

scrape_configs:
  - job_name: system
    static_configs:
      - labels:
          job: server_logs
          server: Achieve-Cargo-Prod-2-V2  # Replace with the server's name
          environment: Production
          __path__: /var/log/*.log     # Logs to be collected (you can change this path as needed)
```

---
